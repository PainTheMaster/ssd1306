#include <stdio.h>
#include "driver/i2c_master.h"
#include "freertos/FreeRTOS.h"

#define RAD_PTN 32

void ssd1306_init(i2c_master_dev_handle_t dev_handle);
void ssd1306_clear();
void ssd1306_dot(i2c_master_dev_handle_t dev_handle, uint8_t i, uint8_t j);
void ssd1306_output(i2c_master_dev_handle_t dev_handle);
void circle(int rad, int i_cent, int j_cent);
void charbitmap(uint8_t code, int row, int col);

uint8_t cambus[64][128];

void app_main(void)
{
    i2c_master_bus_config_t i2c_mst_config = {
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .i2c_port = 0,
        .scl_io_num = 26,
        .sda_io_num = 25,
        .glitch_ignore_cnt = 7,
        .flags.enable_internal_pullup = true,
    };

    i2c_master_bus_handle_t bus_handle;
    i2c_new_master_bus(&i2c_mst_config, &bus_handle);

    i2c_device_config_t dev_cfg = {
        .dev_addr_length = I2C_ADDR_BIT_LEN_7,
        .device_address = 0x3C,
        .scl_speed_hz = 1000000,
    };

    i2c_master_dev_handle_t dev_handle;
    ESP_ERROR_CHECK(i2c_master_bus_add_device(bus_handle, &dev_cfg, &dev_handle));

    
    const uint8_t ctrl_cmd = 0x00;
    const uint8_t ctrl_data = 0x40;

    uint8_t buf_cmd[32];

/*    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xaf; //on
    buf_cmd[2] = 0xa5; //entire display on
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);

    vTaskDelay(pdMS_TO_TICKS(500));
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xae; //off
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);

    vTaskDelay(pdMS_TO_TICKS(500));
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xaf;
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);

    vTaskDelay(pdMS_TO_TICKS(500));
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xae;
    buf_cmd[2] = 0x8d;
    buf_cmd[3] = 0x14;    
    i2c_master_transmit(dev_handle,buf_cmd, 4, -1);

    vTaskDelay(pdMS_TO_TICKS(500));
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xaf;
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);*/

    uint8_t disp_buff1[132];
    disp_buff1[0] = ctrl_data;
    int i;
    for (i=1; i <= 131; i++){
        disp_buff1[i] = 0xff;
    }

    uint8_t disp_buff2[132];
    disp_buff2[0] = ctrl_data;
    for (i=1; i <= 131; i++){
        disp_buff2[i] = 0x00;
    }

    uint8_t disp_buff3[132];
    disp_buff3[0] = ctrl_data;
    for (i=1; i <= 131; i++){
        if(i%5==0){
            disp_buff3[i] = 0xff;
        }else{
            disp_buff3[i] = 0x00;
        }
    }

    ssd1306_init(dev_handle);

    vTaskDelay(pdMS_TO_TICKS(100));
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xb0; //page0
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0x00; 
    buf_cmd[2] = 0x10;  //start seg 0
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);
    i2c_master_transmit(dev_handle,disp_buff1, 129, -1);

    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xb1; //page1
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0x00; 
    buf_cmd[2] = 0x10;  //start seg 0
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);
    i2c_master_transmit(dev_handle,disp_buff2, 129, -1);

    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xb2; //page2
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0x00; 
    buf_cmd[2] = 0x10;  //start seg 0
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);
    i2c_master_transmit(dev_handle,disp_buff1, 129, -1);

    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xb3; //page3
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0x00; 
    buf_cmd[2] = 0x10;  //start seg 0
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);
    i2c_master_transmit(dev_handle,disp_buff3, 129, -1);

    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xb4; //page4
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0x00; 
    buf_cmd[2] = 0x10;  //start seg 0
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);
    i2c_master_transmit(dev_handle,disp_buff3, 129, -1);

    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xb5; //page5
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0x00; 
    buf_cmd[2] = 0x10;  //start seg 0
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);
    i2c_master_transmit(dev_handle,disp_buff1, 129, -1);

    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xb6; //page6
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0x00; 
    buf_cmd[2] = 0x10;  //start seg 0
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);
    i2c_master_transmit(dev_handle,disp_buff2, 129, -1);

    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0xb7; //page7
    i2c_master_transmit(dev_handle,buf_cmd, 2, -1);
    buf_cmd[0] = ctrl_cmd;
    buf_cmd[1] = 0x00; 
    buf_cmd[2] = 0x10;  //start seg 0
    i2c_master_transmit(dev_handle,buf_cmd, 3, -1);
    i2c_master_transmit(dev_handle,disp_buff1, 129, -1);
    vTaskDelay(pdMS_TO_TICKS(500));

    ssd1306_clear();
    ssd1306_output(dev_handle);

//    int i;
    for(i=0; i<=63; i++){
        ssd1306_dot(dev_handle, i, i);
    }

    vTaskDelay(pdMS_TO_TICKS(500));

    ssd1306_clear();

    int j;
    for (i=0; i<=63; i++){
        for(j=0; j <=127; j++){
            cambus[i][j] = 0;
        }
        cambus[i][127-i] = 1;
    }
    ssd1306_output(dev_handle);
    printf("line done\n");
    vTaskDelay(pdMS_TO_TICKS(500));

    for (i=0; i<=63; i++){
        for(j=0; j <=63; j++){
            cambus[i][j] = 1;
        }
        for(j=64; j <=127; j++){
            cambus[i][j] = 0;
        }
    }
    ssd1306_output(dev_handle);
    vTaskDelay(pdMS_TO_TICKS(500));

    for (i=0; i<=63; i++){
        for(j=0; j <=127; j++){
            cambus[i][j] = 0;
        }
    }
    ssd1306_output(dev_handle);
    vTaskDelay(pdMS_TO_TICKS(500));
    circle(5, 31, 63);
    ssd1306_output(dev_handle);
    vTaskDelay(pdMS_TO_TICKS(500));
    ssd1306_clear();
    circle(10, 31, 63);
    ssd1306_output(dev_handle);
    vTaskDelay(pdMS_TO_TICKS(500));
    ssd1306_clear();
    circle(20, 31, 63);
    ssd1306_output(dev_handle);
    vTaskDelay(pdMS_TO_TICKS(500));
    ssd1306_clear();
    circle(40, 31, 63);
    ssd1306_output(dev_handle);
    vTaskDelay(pdMS_TO_TICKS(500));

    ssd1306_clear();
    ssd1306_output(dev_handle);

    charbitmap('0', 0, 0);
    charbitmap('1', 0, 8);    
    charbitmap('2', 0, 16);
    charbitmap('3', 0, 24);
    charbitmap('4', 0, 32);
    charbitmap('5', 0, 40);
    charbitmap('6', 0, 48);
    charbitmap('7', 0, 56);
    charbitmap('8', 0, 64);
    charbitmap('9', 0, 72);

    

    charbitmap('A', 16, 0);
    charbitmap('B', 16, 8);    
    charbitmap('C', 16, 16);
    charbitmap('D', 16, 24);
    charbitmap('E', 16, 32);
    charbitmap('F', 16, 40);
    charbitmap('G', 16, 48);
    charbitmap('H', 16, 56);
    charbitmap('I', 16, 64);
    charbitmap('J', 16, 72);
    charbitmap('K', 16, 80);
    charbitmap('L', 16, 88);
    charbitmap('M', 16, 96);
    charbitmap('N', 16, 104);
    charbitmap('O', 16, 112);
    charbitmap('P', 16, 120);

    charbitmap('Q', 24, 0);
    charbitmap('R', 24, 8);
    charbitmap('S', 24, 16);
    charbitmap('T', 24, 24);
    charbitmap('U', 24, 32);
    charbitmap('V', 24, 40);
    charbitmap('W', 24, 48);
    charbitmap('X', 24, 56);
    charbitmap('Y', 24, 64);
    charbitmap('Z', 24, 72);

     
    ssd1306_output(dev_handle);

/*
    ssd1306_clear();
    int r, x, y, vx, vy;
    r = 10;
    x = r;
    y = r;
    vx=2;
    vy=4;
    while(true){
        ssd1306_clear();
        circle(r, y, x);
        ssd1306_output(dev_handle);
        if((x<=r && vx < 0) || ( 127-r<=x && vx>0)){
            vx *= -1;
        }
        if((y<=r && vy < 0) || ( 63-r<=y && vy>0)){
            vy *= -1;
        }
        x +=vx;
        y +=vy;
        vTaskDelay(pdMS_TO_TICKS(50));
    }*/
}


void ssd1306_init(i2c_master_dev_handle_t dev_handle){
    const uint8_t init_ctrl_cmd = 0x00;
    const uint8_t init_ctrl_data = 0x40;

    uint8_t buf_cmd[32];

    buf_cmd[0] = init_ctrl_cmd;
    buf_cmd[1] = 0xae;  //off
    buf_cmd[2] = 0xa6;  //normal display
    buf_cmd[3] = 0x2e;  //deactivate scroll
    buf_cmd[4] = 0x20;  //set memory addressing mode
    buf_cmd[5] = 0x02;  //memory addressing mode = page addressing mode
    buf_cmd[6] = 0x00;  buf_cmd[7] = 0x10;  //column start address 0
    buf_cmd[8] = 0x40;  //display RAM stat line 0
    buf_cmd[9] = 0xa0;  //column address 0 is mapped to SEG0
    buf_cmd[10] = 0xa8; buf_cmd[11] = 0x3f; //multiplex ratio 63+1=64
    buf_cmd[12] = 0xa4; //GDDRAM
    buf_cmd[13] = 0x8d; buf_cmd[14] = 0x14; //charge pump enable 
    buf_cmd[15] = 0xaf;  //on
    i2c_master_transmit(dev_handle,buf_cmd, 16, -1);
    vTaskDelay(pdMS_TO_TICKS(100));
}

void ssd1306_clear(){
    int i, j;
    for (i=0; i<=63; i++){
        for(j=0; j <=127; j++){
            cambus[i][j] = 0;
        }
    }
}

void ssd1306_dot(i2c_master_dev_handle_t dev_handle, uint8_t i, uint8_t j){
    const uint8_t dot_ctrl_cmd = 0x00;
    const uint8_t dot_ctrl_data = 0x40;
    const uint8_t dot_cmd_page = 0xb0;

    uint8_t page = i/8;
    uint8_t com = i%8;

    uint8_t dot_buf_cmd[4];
    dot_buf_cmd[0]=dot_ctrl_cmd;
    dot_buf_cmd[1]=0xb0+page;
    dot_buf_cmd[2]=0x00 + (j & 0x0f); 
    dot_buf_cmd[3]=0x10 + (j >> 4); 
    i2c_master_transmit(dev_handle,dot_buf_cmd, 4, -1);

    uint8_t dot_buf_disp[2];
    dot_buf_disp[0] = dot_ctrl_data;
    dot_buf_disp[1] = (uint8_t)(1)<<(com);
    i2c_master_transmit(dev_handle,dot_buf_disp, 2, -1);    
}

void ssd1306_output(i2c_master_dev_handle_t dev_handle){
    uint8_t buf_out[8][129];
    uint8_t buf_cmd[3], ret_cmd[3];
    int i_cam, j_cam;
    int page, i_page, seg;

    for (page=0; page <= 7; page++){
        buf_out[page][0]=0x40; //graphic data tag
        for(seg=1; seg<=128; seg++){
            buf_out[page][seg]=0;
        }
    }
    for (i_cam=0; i_cam <= 63; i_cam++){
        page = i_cam/8;
        i_page = i_cam % 8;
        for (j_cam=0; j_cam <= 127; j_cam++){
            seg = j_cam+1;
            buf_out[page][seg] |= (cambus[i_cam][j_cam]) << i_page; 
        }
    }
    

    ret_cmd[0] = 0x00;//cmd tag
    ret_cmd[1] = 0x00;//start segment nibble
    ret_cmd[2] = 0x10;//start segment nibble

    buf_cmd[0] = 0x00; //cmd tag

    
    for (page=0; page <=7; page++){
        i2c_master_transmit(dev_handle, ret_cmd, 3, -1);
        buf_cmd[1] = 0xb0 | ((uint8_t)(page));
        i2c_master_transmit(dev_handle, buf_cmd, 2, -1);
        i2c_master_transmit(dev_handle, buf_out[page], 129, -1);
    }
}


void circle(int rad, int i_cent, int j_cent){
    const int rad_ptn = RAD_PTN;
    const int i_cent_ptn = RAD_PTN;
    const int j_cent_ptn = RAD_PTN;
    const uint8_t pattern[RAD_PTN*2+1][RAD_PTN*2+1] = {
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0},
        {0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0},
        {0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0},
        {0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0},
        {0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0},
        {0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0},
        {0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0},
        {0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0},
        {0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0},
        {0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0},
        {0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0},
        {0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
        {0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
        {0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
        {0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
        {0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
        {0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0},
        {0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0},
        {0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0},
        {0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0},
        {0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0},
        {0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0},
        {0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0},
        {0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0},
        {0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0},
        {0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0},
        {0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
        {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
    };

    int left, right, top, bottom;
    //描画範囲の決定
    if ((left=j_cent-rad)<0){
        left = 0;
    }
    if((right=j_cent+rad)>127){
        right=127;
    }
    if((top=i_cent-rad)<0){
        top = 0;
    }
    if((bottom=i_cent+rad)>63){
        bottom = 63;
    }

    int i_cam_abs, j_cam_abs;
    int i_cam_rel, j_cam_rel;
    int i_ptn_abs, j_ptn_abs;
    int i_ptn_rel, j_ptn_rel;
    const float scale = (float)(rad_ptn)/(float)(rad);

    for(i_cam_abs=top; i_cam_abs<=bottom; i_cam_abs++){
        i_cam_rel = i_cam_abs - i_cent;
        i_ptn_rel = (int)(scale*i_cam_rel);
        i_ptn_abs = i_ptn_rel + i_cent_ptn;
        for(j_cam_abs=left; j_cam_abs<=right; j_cam_abs++){
            j_cam_rel = j_cam_abs - j_cent;
            j_ptn_rel = (int)(scale*j_cam_rel);
            j_ptn_abs = j_ptn_rel + j_cent_ptn;
            cambus[i_cam_abs][j_cam_abs] = pattern[i_ptn_abs][j_ptn_abs];
        }
    }

}


void charbitmap(const uint8_t code, const int row, const int col){
    static const uint8_t bitmap[128][8] = {
        {}, //0x00
        {}, //0x01
        {}, //0x02
        {}, //0x03
        {}, //0x04
        {}, //0x05
        {}, //0x06
        {}, //0x07
        {}, //0x08
        {}, //0x09
        {}, //0x0a
        {}, //0x0b
        {}, //0x0c
        {}, //0x0d
        {}, //0x0e
        {}, //0x0f
        {}, //0x10
        {}, //0x11
        {}, //0x12
        {}, //0x13
        {}, //0x14
        {}, //0x15
        {}, //0x16
        {}, //0x17
        {}, //0x18
        {}, //0x19
        {}, //0x1a
        {}, //0x1b
        {}, //0x1c
        {}, //0x1d
        {}, //0x1e
        {}, //0x1f
        {}, //0x20
        {}, //0x21
        {}, //0x22
        {}, //0x23
        {}, //0x24
        {}, //0x25
        {}, //0x26
        {}, //0x27
        {}, //0x28
        {}, //0x29
        {}, //0x2a
        {}, //0x2b
        {}, //0x2c
        {}, //0x2d
        {}, //0x2e
        {}, //0x2f
        {62, 127, 121, 77, 71, 127, 62, 0}, //0x30, '0'
        {0, 68, 70, 127, 127, 64, 64, 0}, //0x31, '1'
        {98, 115, 81, 89, 73, 111, 102, 0}, //0x32, '2'
        {34, 99, 73, 73, 73, 127, 54, 0}, //0x33, '3'
        {24, 28, 22, 83, 127, 127, 80, 0}, //0x34, '4'
        {39, 103, 69, 69, 69, 125, 57, 0}, //0x35, '5'
        {62, 127, 73, 73, 73, 123, 50, 0}, //0x36, '6'
        {3, 3, 113, 121, 13, 7, 3, 0}, //0x37, '7'
        {54, 127, 73, 73, 73, 127, 54, 0}, //0x38, '8'
        {38, 111, 73, 73, 73, 127, 62, 0}, //0x39, '9'
        {}, //0x3a, ''
        {}, //0x3b, ''
        {}, //0x3c, ''
        {}, //0x3d, ''
        {}, //0x3e, ''
        {}, //0x3f, ''
        {}, //0x40, ''
        {126, 127, 9, 9, 9, 127, 126, 0}, //0x41, 'A'
        {65, 127, 127, 73, 73, 127, 54, 0}, //0x42, 'B'
        {62, 127, 65, 65, 65, 99, 34, 0}, //0x43, 'C'
        {65, 127, 127, 65, 65, 127, 62, 0}, //0x44, 'D'
        {65, 127, 127, 73, 93, 65, 99, 0}, //0x45, 'E'
        {65, 127, 127, 73, 29, 1, 3, 0}, //0x46, 'F'
        {62, 127, 65, 65, 81, 119, 118, 0}, //0x47, 'G'
        {127, 127, 8, 8, 8, 127, 127, 0}, //0x48, 'H'
        {0, 0, 65, 127, 127, 65, 0, 0}, //0x49, 'I'
        {48, 112, 64, 65, 127, 63, 1, 0}, //0x4a, 'J'
        {65, 127, 127, 8, 28, 119, 99, 0}, //0x4b, 'K'
        {65, 127, 127, 65, 64, 96, 112, 0}, //0x4c, 'L'
        {127, 126, 12, 24, 12, 126, 127, 0}, //0x4d, 'M'
        {127, 127, 6, 12, 24, 127, 127, 0}, //0x4e, 'N'
        {62, 127, 65, 65, 65, 127, 62, 0}, //0x4f, 'O'
        {65, 127, 127, 73, 9, 15, 6, 0}, //0x50, 'P'
        {62, 127, 65, 113, 97, 255, 190, 0}, //0x51, 'Q'
        {65, 127, 127, 9, 9, 127, 118, 0}, //0x52, 'R'
        {38, 111, 73, 73, 73, 123, 50, 0}, //0x53, 'S'
        {0, 7, 65, 127, 127, 65, 7, 0}, //0x54, 'T'
        {63, 127, 64, 64, 64, 127, 63, 0}, //0x55, 'U'
        {15, 31, 48, 96, 48, 31, 15, 0}, //0x56, 'V'
        {127, 63, 24, 12, 24, 63, 127, 0}, //0x57, 'W'
        {65, 99, 62, 28, 62, 99, 65, 0}, //0x58, 'X'
        {0, 7, 79, 120, 120, 79, 7, 0}, //0x59, 'Y'
        {71, 99, 113, 89, 77, 103, 115, 0}, //0x5a, 'Z'
        {}, //0x5b, ''
        {}, //0x5c, ''
        {}, //0x5d, ''
        {}, //0x5e, ''
        {}, //0x5f, ''
        {}, //0x60, ''
        {}, //0x61, ''
        {}, //0x62, ''
        {}, //0x63, ''
        {}, //0x64, ''
        {}, //0x65, ''
        {}, //0x66, ''
        {}, //0x67, ''
        {}, //0x68, ''
        {}, //0x69, ''
        {}, //0x6a, ''
        {}, //0x6b, ''
        {}, //0x6c, ''
        {}, //0x6d, ''
        {}, //0x6e, ''
        {}, //0x6f, ''
        {}, //0x70, ''
        {}, //0x71, ''
        {}, //0x72, ''
        {}, //0x73, ''
        {}, //0x74, ''
        {}, //0x75, ''
        {}, //0x76, ''
        {}, //0x77, ''
        {}, //0x78, ''
        {}, //0x79, ''
        {}, //0x7a, ''
        {}, //0x7b, ''
        {}, //0x7c, ''
        {}, //0x7d, ''
        {}, //0x7e, ''
        {} //0x7f, ''
    };

    int i, j;
    for (j=0; j <=7; j++){
        for (i=0; i <=7; i++){
            cambus[row+i][col+j]=(bitmap[code][j]>>i)&((uint8_t)(1));
            printf("i %d, j %d\n", row+i, col+j);
        }
    }
}